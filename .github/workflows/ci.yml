name: CI

on:
  push:
    branches: [main]
    tags: ['*']
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    container: quay.io/fedora/fedora:latest
    steps:
      - name: Install tools
        run: dnf install -y cargo clippy rustfmt just ShellCheck nodejs-npm openssl-devel git jq
      - name: Configure git
        run: git config --global --add safe.directory '*'
      - name: Checkout
        uses: actions/checkout@v6
      - name: Install markdownlint
        run: npm install -g markdownlint-cli
        # do this first to avoid building implicitly bumping the lockfile
      - name: Verify Cargo.lock and README.md are in sync
        run: just versioncheck
      - name: Build
        run: just build
      - name: Check
        run: just checkall

  msrv:
    runs-on: ubuntu-latest
    container: registry.access.redhat.com/ubi9/ubi:latest
    steps:
      - name: Install tools
        run: dnf install -y rust-toolset openssl-devel zlib-devel git
      - name: Configure git
        run: git config --global --add safe.directory '*'
      - name: Checkout
        uses: actions/checkout@v6
      - name: Build
        run: cargo build
      - name: Test
        run: cargo test

  e2e-tests:
    needs: unit-tests
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
          - arch: arm64
            runner: ubuntu-24.04-arm
    permissions:
      contents: read
      packages: write
    container:
      image: quay.io/fedora/fedora:latest
      options: --privileged --cgroupns=host -v /var/lib/containers -v /var/tmp -v /tmp
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Install tools
        run: dnf install -y just buildah podman skopeo jq
      - name: Build image
        run: just buildimg
      - name: Run tests
        run: just test
      - name: Push to ghcr.io
        if: github.event_name == 'push'
        run: |
          set -euo pipefail
          podman login -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }} ghcr.io
          podman push chunkah ghcr.io/${{ github.repository }}:${{ github.sha }}-${{ matrix.arch }}

  manifest:
    needs: e2e-tests
    if: github.event_name == 'push'
    runs-on: ubuntu-24.04
    permissions:
      packages: write
    steps:
      - name: Create and push manifest
        run: |
          set -euo pipefail
          podman login -u ${{ github.actor }} -p ${{ secrets.GITHUB_TOKEN }} ghcr.io
          podman manifest create ghcr.io/${{ github.repository }}:${{ github.sha }} \
            ghcr.io/${{ github.repository }}:${{ github.sha }}-amd64 \
            ghcr.io/${{ github.repository }}:${{ github.sha }}-arm64
          podman manifest push ghcr.io/${{ github.repository }}:${{ github.sha }}
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
            podman tag ghcr.io/${{ github.repository }}:${{ github.sha }} ghcr.io/${{ github.repository }}:${TAG}
            podman manifest push ghcr.io/${{ github.repository }}:${TAG}
          else
            podman tag ghcr.io/${{ github.repository }}:${{ github.sha }} ghcr.io/${{ github.repository }}:latest
            podman manifest push ghcr.io/${{ github.repository }}:latest
          fi

  release:
    needs: manifest
    if: github.event_name == 'push'
    runs-on: ubuntu-24.04
    permissions:
      packages: write
    steps:
      - name: Install skopeo
        run: sudo apt-get update && sudo apt-get install -y skopeo
      - name: Push to quay.io
        run: |
          set -euo pipefail
          mkdir -p ~/.docker
          echo '${{ secrets.QUAY_AUTH }}' > ~/.docker/config.json
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            TAG="${GITHUB_REF#refs/tags/}"
            skopeo copy --all --src-creds=${{ github.actor }}:${{ secrets.GITHUB_TOKEN }} \
              docker://ghcr.io/${{ github.repository }}:${{ github.sha }} docker://quay.io/jlebon/chunkah:${TAG}
            skopeo copy --all --src-creds=${{ github.actor }}:${{ secrets.GITHUB_TOKEN }} \
              docker://ghcr.io/${{ github.repository }}:${{ github.sha }} docker://quay.io/jlebon/chunkah:latest
          else
            skopeo copy --all --src-creds=${{ github.actor }}:${{ secrets.GITHUB_TOKEN }} \
              docker://ghcr.io/${{ github.repository }}:${{ github.sha }} docker://quay.io/jlebon/chunkah:dev
          fi
      - name: Cleanup old images
        uses: actions/delete-package-versions@v5
        with:
          package-name: chunkah
          package-type: container
          min-versions-to-keep: 20
          ignore-versions: '^v.*$'
